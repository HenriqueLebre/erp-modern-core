@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Home - ERP Modern</PageTitle>

<div class="container mt-5">
    <AuthorizeView>
        <Authorized>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-body text-center p-5">
                            <h1 class="display-4 mb-4">‚úÖ Autenticado com Sucesso!</h1>
                            
                            <div class="alert alert-success" role="alert">
                                <h4 class="alert-heading">Bem-vindo, @context.User.Identity?.Name!</h4>
                                <p>Voc√™ est√° autenticado e pronto para usar o sistema.</p>
                            </div>
                            
                            <div class="d-grid gap-3 mt-4">
                                <button class="btn btn-primary btn-lg" @onclick="OpenLegacyERP">
                                    üöÄ Abrir ERP Legado
                                </button>
                                
                                <button class="btn btn-outline-secondary" @onclick="Logout">
                                    üö™ Sair
                                </button>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(statusMessage))
                            {
                                <div class="alert alert-info mt-4" role="alert">
                                    @statusMessage
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(debugInfo))
                            {
                                <div class="alert alert-warning mt-4" role="alert">
                                    <strong>Debug:</strong> @debugInfo
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </Authorized>
        <NotAuthorized>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-body text-center p-5">
                            <h2 class="mb-4">üîê Acesso Restrito</h2>
                            <p class="text-muted mb-4">Voc√™ precisa fazer login para acessar esta p√°gina.</p>
                            <a href="/login" class="btn btn-primary btn-lg">
                                Fazer Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private string? statusMessage;
    private string? debugInfo;
    private string? currentToken;
    
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            // Tentar obter token de diferentes claims
            currentToken = user.FindFirst("token")?.Value 
                        ?? user.FindFirst("access_token")?.Value
                        ?? user.FindFirst("jwt")?.Value;
            
            if (string.IsNullOrEmpty(currentToken))
            {
                debugInfo = "‚ö†Ô∏è Token n√£o encontrado nos claims. Verifique CustomAuthStateProvider.";
            }
            else
            {
                debugInfo = $"‚úÖ Token encontrado! ({currentToken.Length} caracteres)";
            }
        }
    }
    
    private async Task OpenLegacyERP()
    {
        if (string.IsNullOrEmpty(currentToken))
        {
            statusMessage = "‚ùå Token n√£o encontrado. Fa√ßa login novamente.";
            debugInfo = "Token est√° vazio. Verifique se CustomAuthStateProvider est√° salvando o token nos claims.";
            return;
        }
        
        try
        {
            // Construir URL do protocol handler
            var protocolUrl = $"sysfood://launch?token={currentToken}";
            
            statusMessage = "üîÑ Abrindo ERP legado... Se nada acontecer, verifique se o protocol handler est√° registrado.";
            debugInfo = $"Protocol URL: {protocolUrl.Substring(0, Math.Min(100, protocolUrl.Length))}...";
            
            // Abrir protocol handler (abre aplica√ß√£o externa)
            await JSRuntime.InvokeVoidAsync("open", protocolUrl, "_self");
            
            // Aguardar 2 segundos
            await Task.Delay(2000);
            
            statusMessage = "‚úÖ Comando enviado! O ERP deve abrir em instantes.";
        }
        catch (Exception ex)
        {
            statusMessage = $"‚ùå Erro ao abrir ERP: {ex.Message}";
            debugInfo = $"Exception: {ex.GetType().Name}";
        }
    }
    
    private void Logout()
    {
        Navigation.NavigateTo("/logout", true);
    }
}